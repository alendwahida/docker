pipeline {
	environment {
		registry = "alendwahida/docker-pipeline"
		registryCredential = 'docker-hub-credentials'
		dockerImage = ''
	}

	agent any

	stages {
		stage('Build-docker') {
			steps {
				sh 'docker container rm -f test-docker-1'
				sh 'docker build -t test-docker .'
				sh 'docker run -d --name test-docker-1 -p 4534:80 test-docker'
			}
		}
		stage('Test-docker') {
			steps {
				sh 'curl http://180.250.125.66:4534'
			}
		}
		stage('Build-Deploy-docker') {
			steps {
				script {
					docker.build registry + ":latest"
					docker.withRegistry( '', registryCredential ) {
            		dockerImage.push()
				}
        	}
		}
	}

	post {
                always {
                        echo 'always !'
                }
                success {
                        echo 'success !'
                }
                failure {
                        echo ' Failed !'
                }
        }

}
